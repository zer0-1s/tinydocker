### Namespace

`nsenter` è¿›å…¥å·²å­˜åœ¨çš„å‘½åç©ºé—´ï¼ˆNamespaceï¼‰å¹¶æ‰§è¡Œå‘½ä»¤ã€‚
```
root@GreenCloud:~# docker run  -d --rm -it ubuntu 
7949ccebd842b7b3c39c7135ef634c62e028f108ede0598ab2818335d639f448
root@GreenCloud:~# docker inspect -f '{{.State.Pid}}' 7949ccebd842b7b3c39c7135ef634c62e028f108ede0598ab2818335d639f448
478030
root@GreenCloud:~# nsenter -t 478030 --net
root@GreenCloud:~# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
12: eth0@if13: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
```
### Cgroups
åœ¨ Linux ä¸­ï¼ŒCgroups ç»™ç”¨æˆ·æš´éœ²å‡ºæ¥çš„æ“ä½œæ¥å£æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œå³å®ƒä»¥æ–‡ä»¶å’Œç›®å½•çš„æ–¹å¼ç»„ç»‡åœ¨æ“ä½œç³»ç»Ÿçš„ /sys/fs/cgroup è·¯å¾„ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ mount -t cgroup å‘½ä»¤æŸ¥çœ‹ Cgroups v1æ–‡ä»¶ç³»ç»Ÿã€‚

```
cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name=systemd)
cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)
cgroup on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)
cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
cgroup on /sys/fs/cgroup/rdma type cgroup (rw,nosuid,nodev,noexec,relatime,rdma)
cgroup on /sys/fs/cgroup/misc type cgroup (rw,nosuid,nodev,noexec,relatime,misc)
cgroup on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
cgroup on /sys/fs/cgroup/net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)
cgroup on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)
cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)
cgroup on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)
cgroup on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)

```
`sys/fs/cgroup`ä¸‹é¢çš„pids,cpu,perf_eventä¹Ÿæ˜¯å­ç³»ç»Ÿã€‚



```
ls /sys/fs/cgroup/cpu
cgroup.clone_children  cgroup.sane_behavior  cpuacct.usage      cpuacct.usage_percpu      cpuacct.usage_percpu_user  cpuacct.usage_user  cpu.cfs_period_us  cpu.idle    cpu.stat    notify_on_release  system.slice  user.slice
cgroup.procs           cpuacct.stat          cpuacct.usage_all  cpuacct.usage_percpu_sys  cpuacct.usage_sys          cpu.cfs_burst_us    cpu.cfs_quota_us   cpu.shares  init.scope  release_agent      tasks
```
release_agent æ˜¯å®¹å™¨é€ƒé€¸ä¸­ä¸€ä¸ªç»å…¸çš„åˆ©ç”¨ç‚¹ï¼Œé€šå¸¸é…åˆ cgroup v1 çš„ notify_on_release å’Œ release_agent å®ç°é€ƒé€¸ã€‚åœ¨ cgroup v2 ä¸­ï¼Œrelease_agent å’Œ notify_on_release æ–‡ä»¶è¢«ç§»é™¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ cgroup.events æ–‡ä»¶ã€‚

` sudo docker run -it  --cpu-quota=2000 ubuntu /bin/bash` åœ¨å¯åŠ¨dockeræ—¶ä¼ å…¥cpu-quotaå‚æ•°ï¼Œæ¥é™åˆ¶å®¹å™¨çš„CPUèµ„æºã€‚å®¹å™¨æœ€å¤šå¯ä»¥ä½¿ç”¨ 2% çš„ CPU æ—¶é—´

```
hids@ubuntu:~$ ls /sys/fs/cgroup/cpu/
cgroup.clone_children  cgroup.sane_behavior  cpuacct.usage      cpuacct.usage_percpu      cpuacct.usage_percpu_user  cpuacct.usage_user  cpu.cfs_period_us  cpu.idle    cpu.stat  init.scope         release_agent  tasks
cgroup.procs           cpuacct.stat          cpuacct.usage_all  cpuacct.usage_percpu_sys  cpuacct.usage_sys          cpu.cfs_burst_us    cpu.cfs_quota_us   cpu.shares  docker    notify_on_release  system.slice   user.slice
hids@ubuntu:~$ ls /sys/fs/cgroup/cpu/docker/
0356f9f6837987ad86dd3e795426cff41d89dbf45a3496e9f012a6a4640d1219  cpuacct.stat       cpuacct.usage_percpu       cpuacct.usage_sys   cpu.cfs_period_us  cpu.shares      cpu.uclamp.min
cgroup.clone_children                                             cpuacct.usage      cpuacct.usage_percpu_sys   cpuacct.usage_user  cpu.cfs_quota_us   cpu.stat        notify_on_release
cgroup.procs                                                      cpuacct.usage_all  cpuacct.usage_percpu_user  cpu.cfs_burst_us    cpu.idle           cpu.uclamp.max  tasks
hids@ubuntu:~$ ls /sys/fs/cgroup/cpu/docker/0356f9f6837987ad86dd3e795426cff41d89dbf45a3496e9f012a6a4640d1219/
cgroup.clone_children  cpuacct.stat   cpuacct.usage_all     cpuacct.usage_percpu_sys   cpuacct.usage_sys   cpu.cfs_burst_us   cpu.cfs_quota_us  cpu.shares  cpu.uclamp.max  notify_on_release
cgroup.procs           cpuacct.usage  cpuacct.usage_percpu  cpuacct.usage_percpu_user  cpuacct.usage_user  cpu.cfs_period_us  cpu.idle          cpu.stat    cpu.uclamp.min  tasks
hids@ubuntu:~$ cat  /sys/fs/cgroup/cpu/docker/0356f9f6837987ad86dd3e795426cff41d89dbf45a3496e9f012a6a4640d1219/cpu.cfs_quota_us 
2000

cat  /sys/fs/cgroup/cpu/docker/0356f9f6837987ad86dd3e795426cff41d89dbf45a3496e9f012a6a4640d1219/tasks 
96507
```
`tasks`æ–‡ä»¶ä¸­åŒ…å«å®¹å™¨è¿›ç¨‹çš„pidä¿¡æ¯
### pivot+unshare

```
# åˆ›å»ºäº†ä¸€ä¸ªè·¯å¾„
$ mkdir pivot 
# å¹¶åœ¨è¿™ä¸ªè·¯å¾„ä¸‹æŒ‚è½½äº†å¤§å°ä¸º1G, ç±»å‹ä¸º tmpfs çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ.
$ mount -n -t tmpfs -o size=1G none pivot

# è¿›å…¥è¿™ä¸ªä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ, å¹¶åˆ¶é€ ä¸€ä¸ªåœ°æ–¹ç”¨äºæŒ‚è½½ä¹‹å‰çš„rootfs
$ cd pivot && mkdir old-rootfs
# å¼€å§‹åˆ‡æ¢rootfs, ç°åœ¨ä»¤pivotæˆä¸ºæ–°çš„rootfs, å¹¶å°†ä¹‹å‰çš„æŒ‚è½½éƒ½æŒ‚åˆ°oldä¸‹
$ unshare -m && pivot_root . old-rootfs

# çœ‹çœ‹æˆ‘ä»¬ç°åœ¨åœ¨å“ªå„¿
$ pwd
/root/pivot

$ cd . && pwd
/
$ ls && mount && ps
-bash: ls:    command not found
-bash: mount: command not found
-bash: ps:    command not found
```
è¿™æ˜¯sudo su ç›´æ¥è¿›å…¥/root/pivotï¼Œè€Œä¸”åœ¨è¿™ä¸ªä¸‹cd .. && pwd ç»“æœä¾ç„¶æ˜¯/
ä¸Šè¿°å°±æ˜¯åˆ©ç”¨ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åšçš„è¿›ç¨‹è§†å›¾çš„éš”ç¦»

```
# å‡†å¤‡binæ–‡ä»¶å¤¹, æˆ‘ä»¬åˆ°æ—¶å€™éœ€è¦ç”¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œçš„lså·¥å…·
$ cd pivot && mkdir bin
$ cp /bin/ls ./bin

# lså·¥å…·ä¾èµ–ä¸€äº›åº“, ç„¶åæˆ‘ä»¬ä¹Ÿææ¥è¿™äº›åº“
$ ldd /bin/ls
        linux-vdso.so.1 =>  (0x00007ffe79396000)
        libselinux.so.1 => /lib/x86_64-linux-gnu/libselinux.so.1 (0x00007f4382997000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f43825cd000)
        libpcre.so.3 => /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f438235d000)
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f4382158000)
        /lib64/ld-linux-x86-64.so.2 (0x00005644db278000)
        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f4381f3b000)
$ mkdir lib lib64
$ cp /lib/x86_64-linux-gnu/<xxx> ./lib
$ cp /lib64/ld-linux-x86-64.so.2 ./lib64

# å¥½! å†æ¥ä¸€æ¬¡! ç»“ç•Œ! å¯ç”¨!
$ unshare -m && 
  pivot_root . old-rootfs/ && 
  cd . && pwd
/
# å¯ä»¥äº†è¿™ä¸€å›! 
$ ls
bin  lib  lib64  old-rootfs
```
ä¸Šè¿°è¿™äº›å·¥å…·, ç”±åº•å±‚å­˜å‚¨é©±åŠ¨ aufs / dm / overlay è”åˆå¤šå±‚é•œåƒæœ€åä¸€èµ·æä¾›ï¼Œç»™ä¸€ä¸ªç©ºç™½çš„éš”ç¦»ç¯å¢ƒæä¾›ä¸€äº›å·¥å…·
ä¸‹é¢æ˜¯åŠ ä¸Šäº†unmountæ“ä½œï¼Œä½†æ˜¯ä¸‹é¢çš„æ²¡æœ‰ç”¨unshare,ç”¨äº†å°±æ˜¯ç¬¬ä¸€ä¸ªæ˜¯ns1,ç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªæ˜¯ns2

![alt text](image.png)

ä¸€èˆ¬è€Œè¨€ï¼Œå®¹å™¨åº•å±‚ä½¿ç”¨clone(),unshare()æ¥åˆ›å»ºæ–°çš„å‘½åç©ºé—´ï¼Œsetns()åŠ å…¥å·²ç»å­˜åœ¨çš„å‘½åç©ºé—´
chroot å’Œ pivot_root éƒ½æ˜¯ Linux ä¸­ç”¨äºæ›´æ”¹è¿›ç¨‹æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å·¥å…·ï¼Œä½†æ˜¯å…·ä½“ç»†èŠ‚å’Œç”¨æ³•æœ‰æ‰€ä¸åŒã€‚

| ç‰¹æ€§ | chroot | pivot_root | 
| --- | --- | --- | 
| åŠŸèƒ½ | æ›´æ”¹æ ¹ç›®å½•çš„è·¯å¾„è§£æï¼Œå°†æŒ‡å®šç›®å½•ä½œä¸ºæ–°çš„æ ¹ç›®å½• | å®Œå…¨åˆ‡æ¢æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶éš”ç¦»æ—§æ ¹ï¼Œå¯å°†æ—§æ ¹ç›®å½•ç§»è‡³å…¶ä»–ä½ç½® | 
| éš”ç¦»ç¨‹åº¦| è¾ƒå¼±ï¼Œæ—§æ ¹ä»å¯é€šè¿‡æŸäº›æ–¹å¼è®¿é—®ï¼ˆå¦‚é€šè¿‡æŒ‚è½½ç‚¹æˆ–ç‰¹æƒè¿›ç¨‹ï¼‰ | è¾ƒå¼ºï¼Œæ—§æ ¹å¯è¢«éš”ç¦»æˆ–å¸è½½ï¼Œéš”ç¦»æ•ˆæœæ›´å¥½ | 
| æŒ‚è½½ç‚¹éš”ç¦» | ä¸å¤„ç†æŒ‚è½½ç‚¹ï¼Œéœ€æ‰‹åŠ¨ç®¡ç†ï¼Œæ— æ³•éš”ç¦»æŒ‚è½½ç‚¹ | æ”¯æŒæŒ‚è½½ç‚¹éš”ç¦»ï¼Œé€‚åˆä¸ Mount Namespace ç»“åˆä½¿ç”¨ï¼Œå¯éš”ç¦»æŒ‚è½½ç‚¹ | 
| å¤æ‚åº¦| ç®€å•ï¼Œæ˜“äºä½¿ç”¨ï¼Œé€‚åˆå¿«é€Ÿéš”ç¦» | æ›´å¤æ‚ï¼Œéœ€è¦æ­£ç¡®é…ç½®ï¼Œæ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼ˆå¦‚è®¾ç½®æ–°çš„æŒ‚è½½ç‚¹ã€ç§»åŠ¨æ—§æ ¹ç­‰ï¼‰ | 
| é€ƒé€¸é£é™© | è¾ƒé«˜ï¼ˆç‰¹æƒè¿›ç¨‹å¯èƒ½é€šè¿‡æŸäº›æ–¹å¼é€ƒé€¸ï¼‰ | è¾ƒä½ï¼ˆç»“åˆ Namespace ä½¿ç”¨æ—¶æ›´å®‰å…¨ï¼‰ | 
| å®¹å™¨é€‚ç”¨æ€§ | æ—©æœŸå®¹å™¨ä½¿ç”¨ï¼Œç°ä»£å®¹å™¨ä¸­è¾ƒå°‘ä½¿ç”¨ï¼Œå› ä¸ºéš”ç¦»æ€§ä¸è¶³ | ç°ä»£å®¹å™¨æ ‡å‡†åšæ³•ï¼Œç»“åˆ Namespace æä¾›æ›´å¥½çš„éš”ç¦»æ€§ | 
| ç³»ç»Ÿè°ƒç”¨ | ä½¿ç”¨ `chroot()` ç³»ç»Ÿè°ƒç”¨æˆ–å‘½ä»¤| ä½¿ç”¨`pivot_root()`ç³»ç»Ÿè°ƒç”¨æˆ–å‘½ä»¤ï¼Œä¾‹å¦‚  | 

å…¶ä¸­ Mount Namespace ä¿®æ”¹çš„ï¼Œæ˜¯å®¹å™¨è¿›ç¨‹å¯¹æ–‡ä»¶ç³»ç»Ÿâ€œæŒ‚è½½ç‚¹â€çš„è®¤çŸ¥ã€‚åªæœ‰åœ¨â€œæŒ‚è½½â€è¿™ä¸ªæ“ä½œå‘ç”Ÿä¹‹åï¼Œè¿›ç¨‹çš„è§†å›¾æ‰ä¼šè¢«æ”¹å˜ã€‚è€Œåœ¨æ­¤ä¹‹å‰ï¼Œæ–°åˆ›å»ºçš„å®¹å™¨ä¼šç›´æ¥ç»§æ‰¿å®¿ä¸»æœºçš„å„ä¸ªæŒ‚è½½ç‚¹ã€‚ä¸Šè¿°çš„chroot()æˆ–è€…pivot_root()å°±æ˜¯è´Ÿè´£ä¿®æ”¹æŒ‚è½½ç‚¹çš„ã€‚

åœ¨å®¹å™¨è¿›ç¨‹å¯åŠ¨ä¹‹å‰é‡æ–°æŒ‚è½½å®ƒçš„æ•´ä¸ªæ ¹ç›®å½•"/"ã€‚è€Œç”±äº Mount Namespace çš„å­˜åœ¨ï¼Œè¿™ä¸ªæŒ‚è½½å¯¹å®¿ä¸»æœºä¸å¯è§ï¼Œæ‰€ä»¥å®¹å™¨è¿›ç¨‹å°±å¯ä»¥åœ¨é‡Œé¢ç¥Ÿéšä¾¿ä¿®æ”¹è‡ªå·±çš„æ–‡ä»¶è€Œä¸ä¼šå½±å“åˆ°å®¿ä¸»æœºã€‚

### rootfs

rootfsç§Ÿå€Ÿå†…æ ¸å’Œå…¶ä»–å®¹å™¨å…±äº«ã€‚rootfsåŒ…å«äº†å¾ˆç±»ä¼¼æ“ä½œç³»ç»Ÿçš„æ ¹ç›®å½•çš„ç»“æ„ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰çš„æ–‡ä»¶å’Œç›®å½•ï¼Œä»¥åŠä¸€äº›å¿…è¦çš„æ–‡ä»¶å’Œç›®å½•ã€‚è¿™ä¹Ÿå¯¼è‡´ä»–çš„ä¾èµ–æ˜¯è¢«å°è£…åˆ°ä¸€èµ·çš„ã€‚

å½“ç„¶å¯ä»¥ï¼Œä¸‹é¢æ˜¯ç»™å°ç™½çš„é€šä¿—è®²è§£ç‰ˆæœ¬ï¼š

---

### ğŸ³ Docker é•œåƒå’Œå®¹å™¨çš„â€œåˆ†å±‚æ±‰å ¡åŒ…â€ç†è§£æ³•

æˆ‘ä»¬å¯ä»¥æŠŠ Docker çš„é•œåƒå’Œå®¹å™¨æƒ³è±¡æˆä¸€ä¸ª**æ±‰å ¡åŒ…**ğŸ”ï¼Œä¸€å±‚ä¸€å±‚åœ°å èµ·æ¥ï¼Œæ¯ä¸€å±‚éƒ½æœ‰å®ƒçš„ä½œç”¨ã€‚

---

#### ä¸€ã€é•œåƒæ˜¯â€œé™æ€çš„å¤šå±‚æ±‰å ¡â€

- **é•œåƒï¼ˆImageï¼‰** æ˜¯æˆ‘ä»¬ç”¨æ¥åˆ›å»ºå®¹å™¨çš„â€œé£ŸæåŒ…â€ï¼Œé‡Œé¢æ˜¯é™æ€çš„æ–‡ä»¶ï¼Œä¸ä¼šå˜åŒ–ã€‚
- é•œåƒä¸æ˜¯ä¸€æ•´å—ä¸œè¥¿ï¼Œè€Œæ˜¯**ä¸€å±‚ä¸€å±‚çš„å åŠ è€Œæˆ**çš„ï¼ˆå°±åƒæ±‰å ¡é‡Œçš„é¢åŒ…ã€ç”Ÿèœã€è‚‰é¥¼ã€é…±æ–™ï¼‰ã€‚ç±»ä¼¼é¢„åˆ¶å¥½çš„èœå“ã€‚

> æ¯ä¸€æ­¥æ„å»ºé•œåƒçš„å‘½ä»¤ï¼ˆæ¯”å¦‚å®‰è£…è½¯ä»¶ã€å¤åˆ¶æ–‡ä»¶ï¼‰éƒ½ä¼šæ–°å¢ä¸€å±‚ã€‚

---

#### äºŒã€å®¹å™¨æ˜¯â€œåŠ¨æ€çš„æ±‰å ¡â€

å®¹å™¨æ˜¯è¿è¡Œä¸­çš„é•œåƒï¼Œå®ƒä¸å…‰åƒé£ŸæåŒ…ï¼Œè¿˜å¾—â€œèƒ½åŠ¨â€ï¼Œæ‰€ä»¥å®ƒæ¯”é•œåƒå¤šäº†ä¸¤å±‚ï¼š

- **åªè¯»å±‚ï¼ˆé•œåƒå±‚ï¼‰**ï¼šå°±æ˜¯ä¹‹å‰é‚£ä¸ªé™æ€æ±‰å ¡çš„åº•å±‚éƒ¨åˆ†ï¼Œåªèƒ½çœ‹ï¼Œä¸èƒ½æ”¹ã€‚
- **init å±‚**ï¼šè£…ä¸€äº›å¯åŠ¨æ—¶éœ€è¦çš„å°ä¿®æ”¹ï¼Œæ¯”å¦‚ `/etc/hosts`ã€`/etc/resolv.conf`ï¼Œè¿™å±‚ä¸“é—¨éš”ç¦»ï¼Œä¸ä¼šè¢«æäº¤ã€‚
- **è¯»å†™å±‚**ï¼šä½ è¿è¡Œå®¹å™¨è¿‡ç¨‹ä¸­åˆ›å»ºçš„æ–‡ä»¶ã€ä¿®æ”¹çš„é…ç½®ã€å†™å…¥çš„æ•°æ®ï¼Œå…¨éƒ½æ”¾åœ¨è¿™ä¸€å±‚ã€‚

---

#### ä¸‰ã€ä¸ºå•¥è¦åˆ†å±‚ï¼Ÿçœç©ºé—´ + æ›´å¿«ï¼

æƒ³è±¡ä¸€ä¸‹ä½ è¦åš 100 ä¸ªæ±‰å ¡ï¼š

- ç”¨ä¸€æ ·çš„é¢åŒ…ã€ç”Ÿèœã€è‚‰é¥¼ï¼Œåªæ”¹ä¸€å±‚é…±æ–™ã€‚
- é‚£å°±ä¸ç”¨æ¯æ¬¡éƒ½åšä¸€æ•´å¥—ï¼Œæ”¹ä¸€å±‚å°±è¡Œï¼è¶…çº§çœäº‹ï¼

è¿™å°±æ˜¯ Docker å¼•å…¥â€œåˆ†å±‚â€çš„å¥½å¤„ï¼š**å¤ç”¨å·²æœ‰çš„å±‚ï¼ŒèŠ‚çœç©ºé—´å’Œæ—¶é—´**ã€‚

---

#### å››ã€è¿™äº›å±‚æ˜¯æ€ä¹ˆç»„åˆåœ¨ä¸€èµ·çš„ï¼Ÿé  UnionFSï¼

Docker ç”¨ä¸€ç§å« **UnionFSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰** çš„æŠ€æœ¯ï¼ŒæŠŠè¿™äº›å±‚â€œå â€åœ¨ä¸€èµ·ï¼Œçœ‹èµ·æ¥å°±åƒä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿã€‚æ­£å¼æœ‰äº†unionfsæ‰æä¾›é‚£ä¸ªäº†ç»Ÿä¸€çš„è§†å›¾ï¼Œçœ‹èµ·æ¥å¥½åƒæ•´ä¸ªç³»ç»Ÿåªæœ‰ä¸€å±‚ä¸€æ ·ï¼Œå®é™…ä¸Šä¸‹é¢åŒ…å«äº†å¾ˆå¤šå±‚ã€‚

OverlayFSï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼š
- ä½¿ç”¨ lowerdirï¼ˆåªè¯»å±‚ï¼‰ã€upperdirï¼ˆå¯å†™å±‚ï¼‰å’Œ workdirï¼ˆå·¥ä½œç›®å½•ï¼‰ç»„åˆæˆä¸€ä¸ªç»Ÿä¸€çš„æŒ‚è½½ç‚¹ã€‚
- æ–‡ä»¶æŸ¥æ‰¾ä»ä¸Šåˆ°ä¸‹ï¼ˆä¼˜å…ˆçº§ï¼šå¯å†™å±‚ > é¡¶å±‚åªè¯»å±‚ > ... > åŸºç¡€å±‚ï¼‰ã€‚
- åˆ é™¤æ–‡ä»¶æ—¶ï¼Œåœ¨å¯å†™å±‚æ ‡è®°ä¸ºâ€œç™½å‡ºâ€ï¼ˆwhiteoutï¼‰ï¼Œéšè—åº•å±‚æ–‡ä»¶



æ¯”å¦‚ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯»å†™å±‚ï¼ˆå¯æ”¹ï¼‰â”‚ â† ä½ è¿è¡Œå®¹å™¨æ—¶å†™å…¥çš„æ•°æ®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Init å±‚       â”‚ â† å¯åŠ¨å®¹å™¨æ—¶çš„åˆå§‹åŒ–é…ç½®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é•œåƒå±‚ï¼ˆåªè¯»ï¼‰ â”‚ â† ä»é•œåƒç»§æ‰¿æ¥çš„æ–‡ä»¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
![alt text](image-1.png)

ä½ çœ‹åˆ°çš„æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿï¼Œä½†å…¶å®æ˜¯â€œæ‹¼â€å‡ºæ¥çš„ã€‚

---

#### äº”ã€åˆ é™¤æ–‡ä»¶æ€ä¹ˆæ“ä½œï¼Ÿé â€œé®ä½å®ƒâ€ï¼

é•œåƒå±‚æ˜¯åªè¯»çš„ï¼Œä¸èƒ½çœŸçš„åˆ æ–‡ä»¶ã€‚é‚£æ€ä¹ˆâ€œåˆ â€å‘¢ï¼Ÿ

ä¸¾ä¸ªä¾‹å­ï¼š

- å‡å¦‚ä½ æƒ³åˆ æ‰é•œåƒå±‚é‡Œçš„ `foo.txt`ã€‚
- Docker ä¼šåœ¨è¯»å†™å±‚åˆ›å»ºä¸€ä¸ªå« `.wh.foo.txt` çš„æ–‡ä»¶ï¼ˆwhiteout æ–‡ä»¶ï¼‰ã€‚
- è¿™æ ·å°±åƒç»™åŸæ–‡ä»¶è’™äº†ä¸€å—å¸ƒï¼Œçœ‹ä¸è§å®ƒï¼Œå®ƒå°±â€œç›¸å½“äºè¢«åˆ æ‰äº†â€ã€‚
ä»æ›´é«˜çš„å±‚æ¬¡è¿›è¡Œé®æŒ¡ã€‚

---

#### æ€»ç»“ä¸€å¥è¯ï¼š

> **Docker å®¹å™¨å°±åƒä¸€ä¸ªæ±‰å ¡åŒ…ï¼Œæ¯ä¸€å±‚éƒ½æœ‰ä¸åŒä½œç”¨ï¼Œç»„åˆèµ·æ¥å°±æ˜¯å®Œæ•´çš„æ“ä½œç³»ç»Ÿã€‚**
